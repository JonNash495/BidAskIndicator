//@version=5
indicator("Advanced Bid Ask Spread Analyzer", shorttitle="BidAskPro", overlay=false)

// ============================================================================
// ПРОДВИНУТЫЙ BID/ASK ИНДИКАТОР С АНАЛИЗОМ
// ============================================================================

// Настройки индикатора
group_main = "Основные настройки"
show_spread_chart = input.bool(true, "Показать график спреда", group=group_main)
show_spread_ma = input.bool(true, "Показать скользящую среднюю спреда", group=group_main)
ma_length = input.int(20, "Период скользящей средней", minval=1, maxval=100, group=group_main)

group_alerts = "Алерты и сигналы"
enable_spike_alert = input.bool(true, "Алерт на резкие изменения спреда", group=group_alerts)
spike_threshold = input.float(2.0, "Порог для определения резкого изменения (%)", minval=0.5, maxval=10.0, group=group_alerts)

group_visual = "Визуальные настройки"
spread_color = input.color(color.red, "Цвет спреда", group=group_visual)
ma_color = input.color(color.blue, "Цвет скользящей средней", group=group_visual)
background_color = input.color(color.new(color.gray, 95), "Цвет фона", group=group_visual)

// ============================================================================
// РАСЧЕТ ДАННЫХ
// ============================================================================

// Получение bid/ask данных (приблизительные расчеты)
bid_price = close * 0.9995
ask_price = close * 1.0005

// Расчет спреда
spread_absolute = ask_price - bid_price
spread_percent = (spread_absolute / close) * 100

// Скользящие средние
spread_ma = ta.sma(spread_percent, ma_length)
spread_ema = ta.ema(spread_percent, ma_length)

// Статистические показатели
spread_max = ta.highest(spread_percent, 50)
spread_min = ta.lowest(spread_percent, 50)
spread_std = ta.stdev(spread_percent, 20)

// ============================================================================
// ОТОБРАЖЕНИЕ ГРАФИКОВ
// ============================================================================

// Основной график спреда
plot(show_spread_chart ? spread_percent : na, "Spread %", color=spread_color, linewidth=2)

// Скользящие средние
plot(show_spread_ma ? spread_ma : na, "MA Spread", color=ma_color, linewidth=1)
plot(show_spread_ma ? spread_ema : na, "EMA Spread", color=color.new(ma_color, 50), linewidth=1)

// Зоны уровней
spread_upper = spread_ma + spread_std
spread_lower = spread_ma - spread_std

// Заполнение между уровнями
fill(plot(spread_upper, "Upper Level", color=color.new(color.red, 80)), 
     plot(spread_lower, "Lower Level", color=color.new(color.green, 80)), 
     color=background_color, title="Spread Range")

// ============================================================================
// СИГНАЛЫ И АЛЕРТЫ
// ============================================================================

// Определение аномальных значений спреда
spread_spike = math.abs(spread_percent - spread_ma) > spike_threshold
spread_high = spread_percent > spread_upper
spread_low = spread_percent < spread_lower

// Визуальные сигналы
plotshape(spread_spike, "Spread Spike", shape.triangleup, location.belowbar, color=color.orange, size=size.small)
plotshape(spread_high, "High Spread", shape.xcross, location.abovebar, color=color.red, size=size.small)
plotshape(spread_low, "Low Spread", shape.xcross, location.belowbar, color=color.green, size=size.small)

// Алерты
alertcondition(spread_spike, title="Spread Spike Alert", message="Резкое изменение спреда: {{plot(\"Spread %\")}}%")
alertcondition(spread_high, title="High Spread Alert", message="Высокий спред: {{plot(\"Spread %\")}}%")
alertcondition(spread_low, title="Low Spread Alert", message="Низкий спред: {{plot(\"Spread %\")}}%")

// ============================================================================
// ИНФОРМАЦИОННАЯ ТАБЛИЦА
// ============================================================================

if barstate.islast
    var table stats_table = table.new(position.top_left, 2, 8, bgcolor=color.white, border_width=1)
    
    // Заголовок
    table.cell(stats_table, 0, 0, "Bid/Ask Statistics", text_color=color.black, text_size=size.normal, bgcolor=color.gray)
    table.cell(stats_table, 1, 0, "Value", text_color=color.black, text_size=size.normal, bgcolor=color.gray)
    
    // Текущие значения
    table.cell(stats_table, 0, 1, "Current Spread:", text_color=color.black, text_size=size.small)
    table.cell(stats_table, 1, 1, str.format("{0,number,#.##}%", spread_percent), text_color=spread_color, text_size=size.small)
    
    table.cell(stats_table, 0, 2, "MA Spread:", text_color=color.black, text_size=size.small)
    table.cell(stats_table, 1, 2, str.format("{0,number,#.##}%", spread_ma), text_color=ma_color, text_size=size.small)
    
    table.cell(stats_table, 0, 3, "EMA Spread:", text_color=color.black, text_size=size.small)
    table.cell(stats_table, 1, 3, str.format("{0,number,#.##}%", spread_ema), text_color=color.new(ma_color, 50), text_size=size.small)
    
    // Статистика
    table.cell(stats_table, 0, 4, "Max (50 bars):", text_color=color.black, text_size=size.small)
    table.cell(stats_table, 1, 4, str.format("{0,number,#.##}%", spread_max), text_color=color.red, text_size=size.small)
    
    table.cell(stats_table, 0, 5, "Min (50 bars):", text_color=color.black, text_size=size.small)
    table.cell(stats_table, 1, 5, str.format("{0,number,#.##}%", spread_min), text_color=color.green, text_size=size.small)
    
    table.cell(stats_table, 0, 6, "Std Dev:", text_color=color.black, text_size=size.small)
    table.cell(stats_table, 1, 6, str.format("{0,number,#.##}%", spread_std), text_color=color.orange, text_size=size.small)
    
    table.cell(stats_table, 0, 7, "Status:", text_color=color.black, text_size=size.small)
    status_text = spread_spike ? "SPIKE" : spread_high ? "HIGH" : spread_low ? "LOW" : "NORMAL"
    status_color = spread_spike ? color.orange : spread_high ? color.red : spread_low ? color.green : color.gray
    table.cell(stats_table, 1, 7, status_text, text_color=status_color, text_size=size.small)

// ============================================================================
// ДОПОЛНИТЕЛЬНЫЕ ИНДИКАТОРЫ
// ============================================================================

// RSI спреда
spread_rsi = ta.rsi(spread_percent, 14)
plot(spread_rsi, "Spread RSI", color=color.purple, display=display.data_window)

// MACD спреда
[macd_line, signal_line, histogram] = ta.macd(spread_percent, 12, 26, 9)
plot(macd_line, "Spread MACD", color=color.blue, display=display.data_window)
plot(signal_line, "Spread Signal", color=color.red, display=display.data_window)

// ============================================================================
// НАСТРОЙКИ ОТОБРАЖЕНИЯ
// ============================================================================

// Настройка осей
hline(0, "Zero Line", color=color.gray, linestyle=hline.style_dashed)
hline(spread_ma, "MA Line", color=ma_color, linestyle=hline.style_dotted)

// Настройка фона
bgcolor(spread_high ? color.new(color.red, 90) : spread_low ? color.new(color.green, 90) : na, title="Spread Background")
