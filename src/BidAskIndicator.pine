//@version=5
indicator("Bid Ask Spread Indicator", shorttitle="BidAsk", overlay=true, max_labels_count=500)

// ============================================================================
// НАСТРОЙКИ ИНДИКАТОРА
// ============================================================================

// Основные настройки
group_main = "Основные настройки"
show_bid_line = input.bool(true, "Показать линию Bid", group=group_main)
show_ask_line = input.bool(true, "Показать линию Ask", group=group_main)
show_spread = input.bool(true, "Показать спред", group=group_main)
show_spread_percent = input.bool(true, "Показать спред в процентах", group=group_main)

// Настройки стиля линий
group_style = "Стиль линий"
bid_color = input.color(color.blue, "Цвет линии Bid", group=group_style)
ask_color = input.color(color.red, "Цвет линии Ask", group=group_style)
line_width = input.int(2, "Толщина линий", minval=1, maxval=5, group=group_style)
line_style = input.string("Solid", "Стиль линий", options=["Solid", "Dashed", "Dotted"], group=group_style)

// Настройки отображения спреда
group_spread = "Настройки спреда"
spread_color = input.color(color.yellow, "Цвет спреда", group=group_spread)
spread_size = input.string("Normal", "Размер текста спреда", options=["Small", "Normal", "Large"], group=group_spread)
spread_position = input.string("Top", "Позиция спреда", options=["Top", "Bottom", "Auto"], group=group_spread)

// Настройки алертов
group_alerts = "Настройки алертов"
enable_spread_alert = input.bool(false, "Включить алерт на спред", group=group_alerts)
spread_threshold = input.float(0.1, "Порог спреда для алерта (%)", minval=0.01, maxval=10.0, step=0.01, group=group_alerts)

// ============================================================================
// ФУНКЦИИ
// ============================================================================

// Функция для получения стиля линии
get_line_style() =>
    switch line_style
        "Dashed" => line.style_dashed
        "Dotted" => line.style_dotted
        => line.style_solid

// Функция для получения размера текста
get_text_size() =>
    switch spread_size
        "Small" => size.small
        "Large" => size.large
        => size.normal

// ============================================================================
// РАСЧЕТ BID/ASK ДАННЫХ
// ============================================================================

// Получение bid/ask данных
// Примечание: В реальном TradingView эти данные доступны только для некоторых инструментов
// Для демонстрации используем приблизительные расчеты на основе OHLC

bid_price = close * 0.9995  // Приблизительный bid (немного ниже close)
ask_price = close * 1.0005  // Приблизительный ask (немного выше close)

// Расчет спреда
spread_absolute = ask_price - bid_price
spread_percent = (spread_absolute / close) * 100

// Сглаживание данных для более стабильного отображения
bid_smooth = ta.sma(bid_price, 3)
ask_smooth = ta.sma(ask_price, 3)
spread_smooth = ta.sma(spread_percent, 3)

// ============================================================================
// ОТОБРАЖЕНИЕ ЛИНИЙ
// ============================================================================

// Создание линий bid/ask
var line bid_line = na
var line ask_line = na

// Обновление линий bid/ask
if show_bid_line and barstate.islast
    if not na(bid_line)
        line.delete(bid_line)
    bid_line := line.new(bar_index - 1, bid_smooth, bar_index, bid_smooth, 
                        color=bid_color, width=line_width, style=get_line_style())

if show_ask_line and barstate.islast
    if not na(ask_line)
        line.delete(ask_line)
    ask_line := line.new(bar_index - 1, ask_smooth, bar_index, ask_smooth, 
                        color=ask_color, width=line_width, style=get_line_style())

// ============================================================================
// ОТОБРАЖЕНИЕ СПРЕДА
// ============================================================================

// Функция для позиционирования спреда
get_spread_y_position() =>
    switch spread_position
        "Top" => ask_smooth + (ask_smooth * 0.002)
        "Bottom" => bid_smooth - (bid_smooth * 0.002)
        => (ask_smooth + bid_smooth) / 2

// Отображение спреда
if show_spread and barstate.islast
    spread_text = show_spread_percent ? 
                  str.format("Spread: {0,number,#.####}%", spread_smooth) : 
                  str.format("Spread: ${0,number,#.##}", spread_absolute)
    
    label.new(bar_index, get_spread_y_position(), 
              text=spread_text, 
              color=spread_color, 
              textcolor=color.white, 
              size=get_text_size(), 
              style=label.style_label_left)

// ============================================================================
// АЛЕРТЫ
// ============================================================================

// Алерт на превышение порога спреда
if enable_spread_alert and spread_percent > spread_threshold
    alert("Спред превысил порог: " + str.format("{0,number,#.##}%", spread_percent), alert.freq_once_per_bar)

// ============================================================================
// ТАБЛИЦА С ДАННЫМИ
// ============================================================================

// Создание таблицы с текущими значениями
if barstate.islast
    var table info_table = table.new(position.top_right, 2, 4, bgcolor=color.white, border_width=1)
    
    table.cell(info_table, 0, 0, "Bid:", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 0, str.format("${0,number,#.####}", bid_smooth), text_color=bid_color, text_size=size.small)
    
    table.cell(info_table, 0, 1, "Ask:", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 1, str.format("${0,number,#.####}", ask_smooth), text_color=ask_color, text_size=size.small)
    
    table.cell(info_table, 0, 2, "Spread:", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 2, str.format("${0,number,#.####}", spread_absolute), text_color=spread_color, text_size=size.small)
    
    table.cell(info_table, 0, 3, "Spread %:", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 3, str.format("{0,number,#.##}%", spread_smooth), text_color=spread_color, text_size=size.small)

// ============================================================================
// ОТЛАДОЧНАЯ ИНФОРМАЦИЯ
// ============================================================================

// Вывод отладочной информации (можно отключить в продакшене)
debug_mode = input.bool(false, "Режим отладки", group="Отладка")
if debug_mode
    plotchar(spread_percent, "Spread %", "•", location.top, color=color.orange, size=size.tiny)
